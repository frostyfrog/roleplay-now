{% macro cssClass(character) %}chara-{{ character.Name|e('css')|replace({' ':''})|replace({'\\':'-'}) }}{% endmacro %}
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ title }} - RP Server</title>
    <link rel="stylesheet" type="text/css" href="{{ rproot }}room.css">
    <style>
      {% for character in characters if character.Name != "Narrator" %}
        .{{ _self.cssClass(character) }} {
          background-color: {{ character.Color }};
          color: {{ character.Contrast }};
        }
      {% endfor %}
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script>
      function cssName(name) {
        return 'chara-' + name.replace(/[^0-9a-zA-Z]/g, function(x) { return '-' + x.charCodeAt(0).toString(16).toUpperCase(); });
      }
      function clickCharaButton(evt) {
        $('#mb-name').val(evt.target.text.trim());
        $('#message-box textarea').focus();
        evt.preventDefault();
      }
      //YIQ algorithm retrieved from:
      // http://24ways.org/2010/calculating-color-contrast/
      function getContrastYIQ(hexcolor){
        var r = parseInt(hexcolor.substr(1,2),16);
        var g = parseInt(hexcolor.substr(3,2),16);
        var b = parseInt(hexcolor.substr(5,2),16);
        var yiq = ((r*299)+(g*587)+(b*114))/1000;
        return (yiq >= 128) ? 'black' : 'white';
      }
      //nl2br equivalent modified from:
      // http://stackoverflow.com/questions/2919337/jquery-convert-line-breaks-to-br-nl2br-equivalent
      function nl2br (str) {   
        return (str + '').replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g, '$1<br />$2');
      }
      $(document).ready(function() {
        $('.character a').click(clickCharaButton);
        $('#message-box').submit(function(evt) {
          evt.preventDefault();
          $.ajax({
            type: 'POST',
            url: '{{ room }}/send',
            data: $('#message-box').serialize(),
          });
          $('#message-box textarea').val('');
        });
        $('#char-form').submit(function(evt) {
          evt.preventDefault();
          //client side check to see if the character exists
          var newName = $('#char-form input[name=name]').val().trim();
          if(!newName) {
            alert('Please enter a name.');
            return;
          }
          try {
            $('.character a').each(function() {
              if(newName === $(this).text().trim()) {
                throw 'Character "' + newName + '" already exists!';
              }
            })
          } catch(ex) {
            alert(ex);
            return;
          }
          //ok? let's submit it
          $.ajax({
            type: 'POST',
            url: '{{ room }}/character',
            data: $('#char-form').serialize(),
          });
          $('#message-box input[name=name]').val(newName);
          $('#message-box textarea').focus();
          $('#char-form')[0].reset();
        });
        $('#message-box textarea').keypress(function(evt) {
          if((evt.keyCode || evt.which) === 13 && !evt.shiftKey && !evt.ctrlKey) {
            evt.preventDefault();
            $('#message-box input[type=submit]')[0].click();
          }
        });
        var timer;
        var numMsg = {{ messageCount }};
        var numChar = {{ characterCount }};
        function update() {
          $.ajax({
            type: 'GET',
            url: '{{ room }}/updates',
            data: { characters: numChar, messages: numMsg },
            success: function(data) {
              // remove empty-room message if it's there
              if(numMsg === 0 && data.messages.length > 0) {
                $('#empty-room').remove();
              }
              // update messages
              for(var i = 0; i < data.messages.length; ++i) {
                if($('.message').length >= {{ postsPerPage }}) {
                  $('.message').slice(0,1).remove();
                }
                $('<div/>', {
                  'class': 'message ' + cssName(data.messages[i].Name)
                }).append(
                  $('<div/>', {
                    'class': 'name',
                    text: data.messages[i].Name
                  })
                ).append(
                  $('<div/>', {
                    'class': 'content',
                    html: nl2br(data.messages[i].Content)
                  })
                ).appendTo('#messages');
              }
              // update characters
              for(var i = 0; i < data.characters.length; ++i) {
                $('<div/>', {
                  'class': 'character'
                }).append(
                  $('<a/>', {
                    href: '#',
                    'class': cssName(data.characters[i].Name),
                    text: data.characters[i].Name
                  })
                ).insertAfter($('#characters .character').last())
                .click(clickCharaButton);
                // as well as giving them css
                $('head').append(
                  $('<style/>', {
                    text: '.' + cssName(data.characters[i].Name)
                      + "{ background-color: " + data.characters[i].Color + "; "
                      + "color: " + getContrastYIQ(data.characters[i].Color) + "; }"
                  })
                );
              }
              // done. prepare for next load
              numMsg += data.messages.length;
              numChar += data.characters.length;
              timer = setTimeout(update, {{ refreshMillis }});
            }
          });
        }
        timer = setTimeout(update, {{ refreshMillis }});
      });
    </script>
  </head>
  <body>
    {% include 'title.html' %}
    <div id="messages">
      {% if messageCount > postsPerPage %}
        <p>These are the latest {{ postsPerPage }} posts.
        To view earlier messages, check the <a href="{{ docroot }}{{ room }}/1">archive</a>.</p>
      {% endif %}
      {% for message in messages %}
        <div class="message {{ _self.cssClass(message) }}">
          <div class="name">{{ message.Name }}</div>
          <div class="content">{{ message.Content|nl2br }}</div>
        </div>
      {% else %}
        <p id="empty-room">Send a message to get started...</p>
      {% endfor %}
    </div>
    <div id="characters">
      {% for character in characters %}
        <div class="character">
          <a href="#" class="{{ _self.cssClass(character) }}">
            {{ character.Name }}
          </a>
        </div>
      {% endfor %}
      <div id="new-character">
        <form id="char-form" action="{{ room }}/character" method="post">
          New Character: <input type="text" name="name"></input>
          Color: <input type="color" name="color" value="#FFFFFF"></input>
          <input type="submit" value="Add"></input>
        </form>
      </div>
    </div>
    <form id="message-box" action="{{ room }}/send" method="post">
      <table>
        <tr>
          <td colspan="2"><input type="text" name="name" id="mb-name" value="Narrator"></input></td>
        </tr>
        <tr>
          <td id="input-col"><textarea name="content"></textarea></td>
          <td id="button-col"><input type="submit" value="Send"></input></td>
        </tr>
      </table>
    </form>
  </body>
</html>