{% macro cssClass(character) %}chara-{{ character.Name|e('css')|replace({' ':''})|replace({'\\':'-'}) }}{% endmacro %}
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ title }} - RP Server</title>
    <link rel="stylesheet" type="text/css" href="{{ rproot }}room.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src='{{ rproot }}spectrum/spectrum.js'></script>
    <link rel='stylesheet' href='{{ rproot }}spectrum/spectrum.css' />
    <style>
      {% for character in characters if character.Name != "Narrator" %}
        .{{ _self.cssClass(character) }} {
          background-color: {{ character.Color }};
          color: {{ character.Contrast }};
        }
      {% endfor %}
    </style>
    <script>
      function cssName(name) {
        return 'chara-' + name.replace(/[^0-9a-zA-Z]/g, function(x) { return '-' + x.charCodeAt(0).toString(16).toUpperCase(); });
      }
      function clickCharaButton(evt) {
        $('#mb-name').val(evt.target.text.trim());
        $('#message-box textarea').focus();
        evt.preventDefault();
      }
      //nl2br equivalent modified from:
      // http://stackoverflow.com/questions/2919337/jquery-convert-line-breaks-to-br-nl2br-equivalent
      function nl2br (str) {   
        return (str + '').replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g, '$1<br />$2');
      }
      
      $(document).ready(function() {
        //timer function for the title bar
        flashTitle = (function() {
          var oldTitle = document.title;
          var alertMsg = null;
          var i = 0;
          var informTimer = null;
          function timerAction() {
            if(i%2) document.title = oldTitle;
            else document.title = alertMsg;
            --i;
            if(i >= 0) informTimer = setTimeout(timerAction, 500);
          }
          document.addEventListener('visibilitychange', function(evt) {
            if(document.visibilityState === 'visible') {
              clearTimeout(informTimer);
              document.title = oldTitle;
            }
          });
          return function(msg, flashes) {
            if(document.visibilityState === 'visible') return;
            i = (flashes===undefined? 1: flashes)*2;
            if(informTimer) clearTimeout(informTimer);
            alertMsg = msg;
            timerAction(msg);
          };
        })();
        {# show the informative message about the archive at the top? #}
        {% if messageCount <= postsPerPage %}
          $('#showing-latest').hide();
        {% endif %}
        //
        $('.character a').click(clickCharaButton);
        $('#message-box').submit(function(evt) {
          evt.preventDefault();
          $.ajax({
            type: 'POST',
            url: '{{ room }}/send',
            data: $('#message-box').serialize(),
            success: updateNow
          });
          $('#message-box textarea').val('');
        });
        $('#char-form').submit(function(evt) {
          evt.preventDefault();
          //client side check to see if the character exists
          var newName = $('#char-form input[name=name]').val().trim();
          if(!newName) {
            alert('Please enter a name.');
            return;
          }
          try {
            $('.character a').each(function() {
              if(newName === $(this).text().trim()) {
                throw 'Character "' + newName + '" already exists!';
              }
            })
          } catch(ex) {
            alert(ex);
            return;
          }
          //ok? let's submit it
          $.ajax({
            type: 'POST',
            url: '{{ room }}/character',
            data: $('#char-form').serialize(),
            success: updateNow
          });
          $('#message-box input[name=name]').val(newName);
          $('#message-box textarea').focus();
          $('#char-form')[0].reset();
        });
        $('#message-box textarea').keypress(function(evt) {
          if((evt.keyCode || evt.which) === 13 && !evt.shiftKey && !evt.ctrlKey) {
            evt.preventDefault();
            $('#message-box input[type=submit]')[0].click();
          }
        });
        var numMsg = {{ messageCount }};
        var numChar = {{ characterCount }};
        var timer = setTimeout(update, {{ refreshMillis }});
        function update() {
          timer = null;
          $.ajax({
            type: 'GET',
            url: '{{ room }}/updates',
            data: { characters: numChar, messages: numMsg },
            success: function(data) {
              // remove empty-room message if it's there
              if(numMsg === 0 && data.messages.length > 0) {
                $('#empty-room').remove();
              }
              // update messages
              for(var i = 0; i < data.messages.length; ++i) {
                if($('.message').length >= {{ postsPerPage }}) {
                  $('.message').slice(0,1).remove();
                }
                $('<div/>', {
                  'class': 'message ' + cssName(data.messages[i].Name)
                }).append(
                  $('<div/>', {
                    'class': 'name',
                    text: data.messages[i].Name
                  })
                ).append(
                  $('<div/>', {
                    'class': 'content',
                    html: nl2br(data.messages[i].Content)
                  })
                ).appendTo('#messages');
              }
              // update characters
              for(var i = 0; i < data.characters.length; ++i) {
                $('<div/>', {
                  'class': 'character'
                }).append(
                  $('<a/>', {
                    href: '#',
                    'class': cssName(data.characters[i].Name),
                    text: data.characters[i].Name
                  })
                ).insertAfter($('#characters .character').last())
                .click(clickCharaButton);
                // as well as giving them css
                $('head').append(
                  $('<style/>', {
                    text: '.' + cssName(data.characters[i].Name)
                      + "{ background-color: " + data.characters[i].Color + "; "
                      + "color: " + data.characters[i].Contrast + "; }"
                  })
                );
              }
              // maybe show the "showing-latest" message
              if(numMsg <= {{ postsPerPage }} && numMsg + data.messages.length > {{ postsPerPage }}) {
                $('#showing-latest').show();
              }
              // show alerts maybe
              if(data.messages.length > 0) {
                flashTitle('* ' + data.messages[data.messages.length -1].Name + ' says...', 3);
              }
              // update counters
              numMsg += data.messages.length;
              numChar += data.characters.length;
              // done. wait and then do this again
              timer = setTimeout(update, {{ refreshMillis }});
            }
          });
        }
        function updateNow() {
          if(timer) {
            clearTimeout(timer);
            update();
          }
        }
      });
    </script>
  </head>
  <body>
    {% include 'title.html' %}
    <div id="messages">
      <div class="info" id="showing-latest">
        <p>These are the latest {{ postsPerPage }} posts.
        To view earlier messages, check the <a href="{{ docroot }}{{ room }}/1">archive</a>.</p>
      </div>
      {% for message in messages %}
        <div class="message {{ _self.cssClass(message) }}">
          <div class="name">{{ message.Name }}</div>
          <div class="content">{{ message.Content|nl2br }}</div>
        </div>
      {% else %}
        <div class="info" id="empty-room">
          <p><b>Success!</b></p>
          <p>The RP {% if title %}&quot;{{ title }}&quot;{% endif %} has been created. Just share this link with some friends, and you can all start roleplaying together, in real time!</p>
          <a href="{{ fullUrl }}">{{ fullUrl }}</a>
          <p>Please keep the following things in mind, however:</p>
          <ol>
            <li><b>Don't lose the link to this room!</b> If you can't find it, you won't be able to find this room again!</li>
            <li>Anyone with a link to this room can play here. <b>Be careful who you share it with!</b></li>
            <li>Currently, the data going to and from this server is not encrypted. <b>Don't post any sensitive information here!</b></li>
            <li>RP Server is currently under development, so there's a small chance your stories could be unexpectedly lost &mdash; so, just in case, you can download a copy of the entire RP by clicking the <b>Export</b> link up top.</li>
          </ol>
          <p>Have fun!</p>
        </div>
      {% endfor %}
    </div>
    <div id="characters">
      {% for character in characters %}
        <div class="character">
          <a href="#" class="{{ _self.cssClass(character) }}">
            {{ character.Name }}
          </a>
        </div>
      {% endfor %}
      <div id="new-character">
        <form id="char-form" action="{{ room }}/character" method="post">
          New Character: <input type="text" name="name"></input>
          Color: <input type="color" name="color" value="#DDDDDD"></input>
          <input type="submit" value="Add"></input>
        </form>
      </div>
    </div>
    <form id="message-box" action="{{ room }}/send" method="post">
      <input type="text" name="name" id="mb-name" value="Narrator"></input>
      <div id="message-bar">
        <div id="message-text">
          <textarea name="content"></textarea>
        </div>
        <div id="message-button">
          <input type="submit" value="Send"></input>
        </div>
      </div>
    </form>
  </body>
</html>